<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Data/Vector/Algorithms/Tim.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-4"></a><span class='hs-comment'>-- |</span>
<a name="line-5"></a><span class='hs-comment'>-- Module      : Data.Vector.Algorithms.Tim</span>
<a name="line-6"></a><span class='hs-comment'>-- Copyright   : (c) 2013-2015 Dan Doel, 2015 Tim Baumann</span>
<a name="line-7"></a><span class='hs-comment'>-- Maintainer  : Dan Doel &lt;dan.doel@gmail.com&gt;</span>
<a name="line-8"></a><span class='hs-comment'>-- Stability   : Experimental</span>
<a name="line-9"></a><span class='hs-comment'>-- Portability : Non-portable (bang patterns)</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- Timsort is a complex, adaptive, bottom-up merge sort. It is designed to</span>
<a name="line-12"></a><span class='hs-comment'>-- minimize comparisons as much as possible, even at some cost in overhead.</span>
<a name="line-13"></a><span class='hs-comment'>-- Thus, it may not be ideal for sorting simple primitive types, for which</span>
<a name="line-14"></a><span class='hs-comment'>-- comparison is cheap. It may, however, be significantly faster for sorting</span>
<a name="line-15"></a><span class='hs-comment'>-- arrays of complex values (strings would be an example, though an algorithm</span>
<a name="line-16"></a><span class='hs-comment'>-- not based on comparison would probably be superior in that particular</span>
<a name="line-17"></a><span class='hs-comment'>-- case).</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- For more information on the details of the algorithm, read on.</span>
<a name="line-20"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><span class='hs-comment'>-- The first step of the algorithm is to identify runs of elements. These can</span>
<a name="line-22"></a><span class='hs-comment'>-- either be non-decreasing or strictly decreasing sequences of elements in</span>
<a name="line-23"></a><span class='hs-comment'>-- the input. Strictly decreasing sequences are used rather than</span>
<a name="line-24"></a><span class='hs-comment'>-- non-increasing so that they can be easily reversed in place without the</span>
<a name="line-25"></a><span class='hs-comment'>-- sort becoming unstable.</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- If the natural runs are too short, they are padded to a minimum value. The</span>
<a name="line-28"></a><span class='hs-comment'>-- minimum is chosen based on the length of the array, and padded runs are put</span>
<a name="line-29"></a><span class='hs-comment'>-- in order using insertion sort. The length of the minimum run size is</span>
<a name="line-30"></a><span class='hs-comment'>-- determined as follows:</span>
<a name="line-31"></a><span class='hs-comment'>--</span>
<a name="line-32"></a><span class='hs-comment'>--   * If the length of the array is less than 64, the minimum size is the</span>
<a name="line-33"></a><span class='hs-comment'>--     length of the array, and insertion sort is used for the entirety</span>
<a name="line-34"></a><span class='hs-comment'>--</span>
<a name="line-35"></a><span class='hs-comment'>--   * Otherwise, a value between 32 and 64 is chosen such that N/min is</span>
<a name="line-36"></a><span class='hs-comment'>--     either equal to or just below a power of two. This avoids having a</span>
<a name="line-37"></a><span class='hs-comment'>--     small chunk left over to merge into much larger chunks at the end.</span>
<a name="line-38"></a><span class='hs-comment'>--</span>
<a name="line-39"></a><span class='hs-comment'>-- This is accomplished by taking the the mininum to be the lowest six bits</span>
<a name="line-40"></a><span class='hs-comment'>-- containing the highest set bit, and adding one if any other bits are set.</span>
<a name="line-41"></a><span class='hs-comment'>-- For instance:</span>
<a name="line-42"></a><span class='hs-comment'>--</span>
<a name="line-43"></a><span class='hs-comment'>--     length: 00000000 00000000 00000000 00011011 = 25</span>
<a name="line-44"></a><span class='hs-comment'>--     min:    00000000 00000000 00000000 00011011 = 25</span>
<a name="line-45"></a><span class='hs-comment'>--</span>
<a name="line-46"></a><span class='hs-comment'>--     length: 00000000 11111100 00000000 00000000 = 63 * 2^18</span>
<a name="line-47"></a><span class='hs-comment'>--     min:    00000000 00000000 00000000 00111111 = 63</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-comment'>--     length: 00000000 11111100 00000000 00000001 = 63 * 2^18 + 1</span>
<a name="line-50"></a><span class='hs-comment'>--     min:    00000000 00000000 00000000 01000000 = 64</span>
<a name="line-51"></a><span class='hs-comment'>--</span>
<a name="line-52"></a><span class='hs-comment'>-- Once chunks can be produced, the next step is merging them. The indices of</span>
<a name="line-53"></a><span class='hs-comment'>-- all runs are stored in a stack. When we identify a new run, we push it onto</span>
<a name="line-54"></a><span class='hs-comment'>-- the stack. However, certain invariants are maintained of the stack entries.</span>
<a name="line-55"></a><span class='hs-comment'>-- Namely:</span>
<a name="line-56"></a><span class='hs-comment'>--</span>
<a name="line-57"></a><span class='hs-comment'>--   if stk = _ :&gt; z :&gt; y :&gt; x</span>
<a name="line-58"></a><span class='hs-comment'>--     length x + length y &lt; length z</span>
<a name="line-59"></a><span class='hs-comment'>--</span>
<a name="line-60"></a><span class='hs-comment'>--   if stk = _ :&gt; y :&gt; x</span>
<a name="line-61"></a><span class='hs-comment'>--     length x &lt; length y</span>
<a name="line-62"></a><span class='hs-comment'>--</span>
<a name="line-63"></a><span class='hs-comment'>-- This ensures that the chunks stored are decreasing, and that the chunk</span>
<a name="line-64"></a><span class='hs-comment'>-- sizes follow something like the fibonacci sequence, ensuring there at most</span>
<a name="line-65"></a><span class='hs-comment'>-- log-many chunks at any time. If pushing a new chunk on the stack would</span>
<a name="line-66"></a><span class='hs-comment'>-- violate either of the invariants, we first perform a merge.</span>
<a name="line-67"></a><span class='hs-comment'>--</span>
<a name="line-68"></a><span class='hs-comment'>-- If length x + length y &gt;= length z, then y is merged with the smaller of x</span>
<a name="line-69"></a><span class='hs-comment'>-- and z (if they are tied, x is chosen, because it is more likely to be</span>
<a name="line-70"></a><span class='hs-comment'>-- cached). If, further,  length x &gt;= length y then they are merged. These steps</span>
<a name="line-71"></a><span class='hs-comment'>-- are repeated until the invariants are established.</span>
<a name="line-72"></a><span class='hs-comment'>--</span>
<a name="line-73"></a><span class='hs-comment'>-- The last important piece of the algorithm is the merging. At first, two</span>
<a name="line-74"></a><span class='hs-comment'>-- chunks are merged element-wise. However, while doing so, counts are kept of</span>
<a name="line-75"></a><span class='hs-comment'>-- the number of elements taken from one chunk without any from its partner. If</span>
<a name="line-76"></a><span class='hs-comment'>-- this count exceeds a threshold, the merge switches to searching for elements</span>
<a name="line-77"></a><span class='hs-comment'>-- from one chunk in the other, and copying chunks at a time. If these chunks</span>
<a name="line-78"></a><span class='hs-comment'>-- start falling below the threshold, the merge switches back to element-wise.</span>
<a name="line-79"></a><span class='hs-comment'>--</span>
<a name="line-80"></a><span class='hs-comment'>-- The search used in the merge is also special. It uses a galloping strategy,</span>
<a name="line-81"></a><span class='hs-comment'>-- where exponentially increasing indices are tested, and once two such indices</span>
<a name="line-82"></a><span class='hs-comment'>-- are determined to bracket the desired value, binary search is used to find</span>
<a name="line-83"></a><span class='hs-comment'>-- the exact index within that range. This is asymptotically the same as simply</span>
<a name="line-84"></a><span class='hs-comment'>-- using binary search, but is likely to do fewer comparisons than binary search</span>
<a name="line-85"></a><span class='hs-comment'>-- would.</span>
<a name="line-86"></a><span class='hs-comment'>--</span>
<a name="line-87"></a><span class='hs-comment'>-- One aspect that is not yet implemented from the original Tim sort is the</span>
<a name="line-88"></a><span class='hs-comment'>-- adjustment of the above threshold. When galloping saves time, the threshold</span>
<a name="line-89"></a><span class='hs-comment'>-- is lowered, and when it doesn't, it is raised. This may be implemented in the</span>
<a name="line-90"></a><span class='hs-comment'>-- future.</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Algorithms</span><span class='hs-varop'>.</span><span class='hs-conid'>Tim</span>
<a name="line-93"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>sort</span>
<a name="line-94"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sortBy</span>
<a name="line-95"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span><span class='hs-layout'>)</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Primitive</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>when</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Generic</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Algorithms</span><span class='hs-varop'>.</span><span class='hs-conid'>Search</span> <span class='hs-layout'>(</span> <span class='hs-varid'>gallopingSearchRightPBounds</span>
<a name="line-106"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>gallopingSearchLeftPBounds</span>
<a name="line-107"></a>                                     <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Algorithms</span><span class='hs-varop'>.</span><span class='hs-conid'>Insertion</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortByBounds'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Comparison</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="sort"></a><span class='hs-comment'>-- | Sorts an array using the default comparison.</span>
<a name="line-111"></a><span class='hs-definition'>sort</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-112"></a><span class='hs-definition'>sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>compare</span>
<a name="line-113"></a><span class='hs-comment'>{-# INLINABLE sort #-}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="sortBy"></a><span class='hs-comment'>-- | Sorts an array using a custom comparison.</span>
<a name="line-116"></a><span class='hs-definition'>sortBy</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-117"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Comparison</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-118"></a><span class='hs-definition'>sortBy</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mr</span> <span class='hs-varop'>==</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iter</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>]</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"no merge buffer needed!"</span><span class='hs-layout'>)</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new</span> <span class='hs-num'>256</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>iter</span> <span class='hs-conid'>[]</span> <span class='hs-num'>0</span>
<a name="line-121"></a> <span class='hs-keyword'>where</span>
<a name="line-122"></a> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>vec</span>
<a name="line-123"></a> <span class='hs-varid'>mr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minrun</span> <span class='hs-varid'>len</span>
<a name="line-124"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-125"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>len</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>performRemainingMerges</span> <span class='hs-varid'>s</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-126"></a>   <span class='hs-keyglyph'>|</span><span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>order</span><span class='hs-layout'>,</span> <span class='hs-varid'>runLen</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nextRun</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>i</span> <span class='hs-varid'>len</span>
<a name="line-127"></a>                    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>order</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Descending</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-128"></a>                      <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>i</span> <span class='hs-varid'>runLen</span> <span class='hs-varid'>vec</span>
<a name="line-129"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>runEnd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-varid'>len</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-varid'>max</span> <span class='hs-varid'>runLen</span> <span class='hs-varid'>mr</span><span class='hs-layout'>)</span>
<a name="line-130"></a>                    <span class='hs-varid'>sortByBounds'</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>runLen</span><span class='hs-layout'>)</span> <span class='hs-varid'>runEnd</span>
<a name="line-131"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmpBuf'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>performMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-conop'>:</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>runEnd</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-132"></a>                    <span class='hs-varid'>iter</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>runEnd</span> <span class='hs-varid'>tmpBuf'</span>
<a name="line-133"></a> <span class='hs-varid'>runLengthInvariantBroken</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-comment'>-</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-134"></a> <span class='hs-varid'>performMerges</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-135"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>b</span> <span class='hs-comment'>-</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>merge</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>performMerges</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>i</span>
<a name="line-136"></a> <span class='hs-varid'>performMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-137"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>runLengthInvariantBroken</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>
<a name="line-138"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>b</span> <span class='hs-comment'>-</span> <span class='hs-varid'>a</span>
<a name="line-139"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>merge</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>performMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-140"></a>       <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tmpBuf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>merge</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-141"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>ass'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmpBuf''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>performMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-varid'>tmpBuf'</span>
<a name="line-142"></a>               <span class='hs-varid'>performMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>ass'</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBuf''</span>
<a name="line-143"></a> <span class='hs-varid'>performMerges</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmpBuf</span><span class='hs-layout'>)</span>
<a name="line-144"></a> <span class='hs-varid'>performRemainingMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>=</span>
<a name="line-145"></a>   <span class='hs-varid'>merge</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>len</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>performRemainingMerges</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-146"></a> <span class='hs-varid'>performRemainingMerges</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-147"></a><span class='hs-comment'>{-# INLINE sortBy #-}</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="minrun"></a><span class='hs-comment'>-- | Computes the minimum run size for the sort. The goal is to choose a size</span>
<a name="line-150"></a><span class='hs-comment'>-- such that there are almost if not exactly 2^n chunks of that size in the</span>
<a name="line-151"></a><span class='hs-comment'>-- array.</span>
<a name="line-152"></a><span class='hs-definition'>minrun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-153"></a><span class='hs-definition'>minrun</span> <span class='hs-varid'>n0</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n0</span> <span class='hs-varop'>`unsafeShiftR`</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>lowMask</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>n0</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span>
<a name="line-154"></a> <span class='hs-keyword'>where</span>
<a name="line-155"></a> <span class='hs-comment'>-- smear the bits down from the most significant bit</span>
<a name="line-156"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n0</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n0</span> <span class='hs-num'>1</span>
<a name="line-157"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n1</span> <span class='hs-num'>2</span>
<a name="line-158"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n2</span> <span class='hs-num'>4</span>
<a name="line-159"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n4</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n3</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n3</span> <span class='hs-num'>8</span>
<a name="line-160"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n5</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n4</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n4</span> <span class='hs-num'>16</span>
<a name="line-161"></a> <span class='hs-varop'>!</span><span class='hs-varid'>n6</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n5</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>unsafeShiftR</span> <span class='hs-varid'>n5</span> <span class='hs-num'>32</span>
<a name="line-162"></a>
<a name="line-163"></a> <span class='hs-comment'>-- mask for the bits lower than the 6 highest bits</span>
<a name="line-164"></a> <span class='hs-varop'>!</span><span class='hs-varid'>lowMask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n6</span> <span class='hs-varop'>`unsafeShiftR`</span> <span class='hs-num'>6</span>
<a name="line-165"></a>
<a name="line-166"></a> <span class='hs-varop'>!</span><span class='hs-varid'>extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>popCount</span> <span class='hs-varid'>lowMask</span>
<a name="line-167"></a><span class='hs-comment'>{-# INLINE minrun #-}</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="Order"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Order</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ascending</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Descending</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="nextRun"></a><span class='hs-comment'>-- | Identify the next run (that is a monotonically increasing or strictly</span>
<a name="line-172"></a><span class='hs-comment'>-- decreasing sequence) in the slice [l,u) in vec. Returns the order and length</span>
<a name="line-173"></a><span class='hs-comment'>-- of the run.</span>
<a name="line-174"></a><span class='hs-definition'>nextRun</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-175"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Comparison</span> <span class='hs-varid'>e</span>
<a name="line-176"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-177"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ l</span>
<a name="line-178"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ u</span>
<a name="line-179"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Order</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-180"></a><span class='hs-definition'>nextRun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ascending</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-181"></a><span class='hs-definition'>nextRun</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>i</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>i</span>
<a name="line-182"></a>                           <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-183"></a>                           <span class='hs-keyword'>if</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`gt`</span> <span class='hs-varid'>y</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>desc</span> <span class='hs-varid'>y</span> <span class='hs-num'>2</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>asc</span>  <span class='hs-varid'>y</span> <span class='hs-num'>2</span>
<a name="line-184"></a> <span class='hs-keyword'>where</span>
<a name="line-185"></a> <span class='hs-varid'>gt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GT</span>
<a name="line-186"></a> <span class='hs-varid'>desc</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-varid'>k</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Descending</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-187"></a> <span class='hs-varid'>desc</span> <span class='hs-varid'>x</span> <span class='hs-varop'>!</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-188"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`gt`</span> <span class='hs-varid'>y</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>desc</span> <span class='hs-varid'>y</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Descending</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-189"></a> <span class='hs-varid'>asc</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-varid'>k</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ascending</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-190"></a> <span class='hs-varid'>asc</span> <span class='hs-varid'>x</span> <span class='hs-varop'>!</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-191"></a>               <span class='hs-keyword'>if</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`gt`</span> <span class='hs-varid'>y</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ascending</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>asc</span> <span class='hs-varid'>y</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-comment'>{-# INLINE nextRun #-}</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="ensureCapacity"></a><span class='hs-comment'>-- | Tests if a temporary buffer has a given size. If not, allocates a new</span>
<a name="line-195"></a><span class='hs-comment'>-- buffer and returns it instead of the old temporary buffer.</span>
<a name="line-196"></a><span class='hs-definition'>ensureCapacity</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-197"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-198"></a><span class='hs-definition'>ensureCapacity</span> <span class='hs-varid'>l</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-varop'>*</span><span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-201"></a><span class='hs-comment'>{-# INLINE ensureCapacity #-}</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="cloneSlice"></a><span class='hs-comment'>-- | Copy the slice [i,i+len) from vec to tmpBuf. If tmpBuf is not large enough,</span>
<a name="line-204"></a><span class='hs-comment'>-- a new buffer is allocated and used. Returns the buffer.</span>
<a name="line-205"></a><span class='hs-definition'>cloneSlice</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-206"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ i</span>
<a name="line-207"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ len</span>
<a name="line-208"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ vec</span>
<a name="line-209"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ tmpBuf</span>
<a name="line-210"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-211"></a><span class='hs-definition'>cloneSlice</span> <span class='hs-varid'>i</span> <span class='hs-varid'>len</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-212"></a>  <span class='hs-varid'>tmpBuf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ensureCapacity</span> <span class='hs-varid'>len</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-213"></a>  <span class='hs-varid'>unsafeCopy</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeSlice</span> <span class='hs-num'>0</span> <span class='hs-varid'>len</span> <span class='hs-varid'>tmpBuf'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>i</span> <span class='hs-varid'>len</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf'</span>
<a name="line-215"></a><span class='hs-comment'>{-# INLINE cloneSlice #-}</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="minGallop"></a><span class='hs-comment'>-- | Number of consecutive times merge chooses the element from the same run</span>
<a name="line-218"></a><span class='hs-comment'>-- before galloping mode is activated.</span>
<a name="line-219"></a><span class='hs-definition'>minGallop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-220"></a><span class='hs-definition'>minGallop</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>7</span>
<a name="line-221"></a><span class='hs-comment'>{-# INLINE minGallop #-}</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="mergeLo"></a><span class='hs-comment'>-- | Merge the adjacent sorted slices [l,m) and [m,u) in vec. This is done by</span>
<a name="line-224"></a><span class='hs-comment'>-- copying the slice [l,m) to a temporary buffer. Returns the (enlarged)</span>
<a name="line-225"></a><span class='hs-comment'>-- temporary buffer.</span>
<a name="line-226"></a><span class='hs-definition'>mergeLo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-227"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Comparison</span> <span class='hs-varid'>e</span>
<a name="line-228"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ vec</span>
<a name="line-229"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ l</span>
<a name="line-230"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ m</span>
<a name="line-231"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ u</span>
<a name="line-232"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ tmpBuf</span>
<a name="line-233"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-234"></a><span class='hs-definition'>mergeLo</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tempBuf'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-235"></a>  <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cloneSlice</span> <span class='hs-varid'>l</span> <span class='hs-varid'>tmpBufLen</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>tempBuf'</span>
<a name="line-236"></a>  <span class='hs-varid'>vi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-num'>0</span>
<a name="line-237"></a>  <span class='hs-varid'>vj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>m</span>
<a name="line-238"></a>  <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-239"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-240"></a> <span class='hs-keyword'>where</span>
<a name="line-241"></a> <span class='hs-varid'>gt</span>  <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GT</span>
<a name="line-242"></a> <span class='hs-varid'>gte</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>LT</span>
<a name="line-243"></a> <span class='hs-varid'>tmpBufLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-comment'>-</span> <span class='hs-varid'>l</span>
<a name="line-244"></a> <span class='hs-varid'>iter</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>tmpBufLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-245"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-246"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpBufLen</span><span class='hs-comment'>-</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-247"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpBufLen</span><span class='hs-comment'>-</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span>
<a name="line-248"></a>   <span class='hs-varid'>unsafeCopy</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-249"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vj</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-250"></a>   <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchLeftPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gt`</span> <span class='hs-varid'>vj</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tmpBufLen</span>
<a name="line-251"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>gallopLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>i</span>
<a name="line-252"></a>       <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>i</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-253"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>k</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-254"></a>   <span class='hs-varid'>unsafeCopy</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-255"></a>   <span class='hs-varid'>vi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i'</span>
<a name="line-256"></a>   <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-varid'>gallopLen</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi'</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-257"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-258"></a>   <span class='hs-varid'>j'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchLeftPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gte`</span> <span class='hs-varid'>vi</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>j</span> <span class='hs-varid'>u</span>
<a name="line-259"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>gallopLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>j</span>
<a name="line-260"></a>       <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-varid'>j</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-261"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-varid'>k</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-262"></a>   <span class='hs-varid'>unsafeMove</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-263"></a>   <span class='hs-varid'>vj'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>j'</span>
<a name="line-264"></a>   <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-varid'>gallopLen</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj'</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-265"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>gb</span>
<a name="line-266"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>vj</span> <span class='hs-varop'>`gte`</span> <span class='hs-varid'>vi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span>
<a name="line-267"></a>                      <span class='hs-varid'>vi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-268"></a>                      <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi'</span> <span class='hs-varid'>vj</span> <span class='hs-layout'>(</span><span class='hs-varid'>ga</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>minGallop</span>
<a name="line-269"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vj</span>
<a name="line-270"></a>                      <span class='hs-varid'>vj'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-271"></a>                      <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj'</span> <span class='hs-varid'>minGallop</span> <span class='hs-layout'>(</span><span class='hs-varid'>gb</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-272"></a><span class='hs-comment'>{-# INLINE mergeLo #-}</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="mergeHi"></a><span class='hs-comment'>-- | Merge the adjacent sorted slices [l,m) and [m,u) in vec. This is done by</span>
<a name="line-275"></a><span class='hs-comment'>-- copying the slice [j,k) to a temporary buffer. Returns the (enlarged)</span>
<a name="line-276"></a><span class='hs-comment'>-- temporary buffer.</span>
<a name="line-277"></a><span class='hs-definition'>mergeHi</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-278"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Comparison</span> <span class='hs-varid'>e</span>
<a name="line-279"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ vec</span>
<a name="line-280"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ l</span>
<a name="line-281"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ m</span>
<a name="line-282"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ u</span>
<a name="line-283"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ tmpBuf</span>
<a name="line-284"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-285"></a><span class='hs-definition'>mergeHi</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tmpBuf'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-286"></a>  <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cloneSlice</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tmpBufLen</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>tmpBuf'</span>
<a name="line-287"></a>  <span class='hs-varid'>vi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-288"></a>  <span class='hs-varid'>vj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpBufLen</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-289"></a>  <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpBufLen</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-290"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-291"></a> <span class='hs-keyword'>where</span>
<a name="line-292"></a> <span class='hs-varid'>gt</span>  <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GT</span>
<a name="line-293"></a> <span class='hs-varid'>gte</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>LT</span>
<a name="line-294"></a> <span class='hs-varid'>tmpBufLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-comment'>-</span> <span class='hs-varid'>m</span>
<a name="line-295"></a> <span class='hs-varid'>iter</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-296"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-297"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-298"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeSlice</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span>
<a name="line-299"></a>   <span class='hs-varid'>unsafeCopy</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-300"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vj</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-301"></a>   <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchRightPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gt`</span> <span class='hs-varid'>vj</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l</span> <span class='hs-varid'>i</span>
<a name="line-302"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>gallopLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>i'</span>
<a name="line-303"></a>       <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-layout'>(</span><span class='hs-varid'>i'</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-304"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-varid'>gallopLen</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-305"></a>   <span class='hs-varid'>unsafeMove</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-306"></a>   <span class='hs-varid'>vi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>i'</span>
<a name="line-307"></a>   <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-varid'>gallopLen</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi'</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-308"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-309"></a>   <span class='hs-varid'>j'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchRightPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gte`</span> <span class='hs-varid'>vi</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-num'>0</span> <span class='hs-varid'>j</span>
<a name="line-310"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>gallopLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span> <span class='hs-comment'>-</span> <span class='hs-varid'>j'</span>
<a name="line-311"></a>       <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-layout'>(</span><span class='hs-varid'>j'</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-312"></a>       <span class='hs-varid'>to</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slice</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-varid'>gallopLen</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>gallopLen</span> <span class='hs-varid'>vec</span>
<a name="line-313"></a>   <span class='hs-varid'>unsafeCopy</span> <span class='hs-varid'>to</span> <span class='hs-varid'>from</span>
<a name="line-314"></a>   <span class='hs-varid'>vj'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>j'</span>
<a name="line-315"></a>   <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-varid'>gallopLen</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj'</span> <span class='hs-varid'>minGallop</span> <span class='hs-varid'>minGallop</span>
<a name="line-316"></a> <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>gb</span>
<a name="line-317"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>vi</span> <span class='hs-varop'>`gt`</span> <span class='hs-varid'>vj</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vi</span>
<a name="line-318"></a>                     <span class='hs-varid'>vi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                     <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi'</span> <span class='hs-varid'>vj</span> <span class='hs-layout'>(</span><span class='hs-varid'>ga</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>minGallop</span>
<a name="line-320"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vj</span>
<a name="line-321"></a>                     <span class='hs-varid'>vj'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-322"></a>                     <span class='hs-varid'>iter</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vi</span> <span class='hs-varid'>vj'</span> <span class='hs-varid'>minGallop</span> <span class='hs-layout'>(</span><span class='hs-varid'>gb</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-323"></a><span class='hs-comment'>{-# INLINE mergeHi #-}</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="merge"></a><span class='hs-comment'>-- | Merge the adjacent sorted slices A=[l,m) and B=[m,u) in vec. This begins</span>
<a name="line-326"></a><span class='hs-comment'>-- with galloping searches to find the index of vec[m] in A and the index of</span>
<a name="line-327"></a><span class='hs-comment'>-- vec[m-1] in B to reduce the sizes of A and B. Then it uses `mergeHi` or</span>
<a name="line-328"></a><span class='hs-comment'>-- `mergeLo` depending on whether A or B is larger. Returns the (enlarged)</span>
<a name="line-329"></a><span class='hs-comment'>-- temporary buffer.</span>
<a name="line-330"></a><span class='hs-definition'>merge</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVector</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-331"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Comparison</span> <span class='hs-varid'>e</span>
<a name="line-332"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ vec</span>
<a name="line-333"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ l</span>
<a name="line-334"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ m</span>
<a name="line-335"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ u</span>
<a name="line-336"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- ^ tmpBuf</span>
<a name="line-337"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-338"></a><span class='hs-definition'>merge</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tmpBuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-339"></a>  <span class='hs-varid'>vm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>m</span>
<a name="line-340"></a>  <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchLeftPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gt`</span> <span class='hs-varid'>vm</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span>
<a name="line-341"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>m</span>
<a name="line-342"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-343"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-344"></a>      <span class='hs-varid'>vn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeRead</span> <span class='hs-varid'>vec</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-345"></a>      <span class='hs-varid'>u'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gallopingSearchRightPBounds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`gte`</span> <span class='hs-varid'>vn</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span>
<a name="line-346"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>u'</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>m</span>
<a name="line-347"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-348"></a>        <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-comment'>-</span><span class='hs-varid'>l'</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>u'</span><span class='hs-comment'>-</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mergeLo</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>mergeHi</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>vec</span> <span class='hs-varid'>l'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u'</span> <span class='hs-varid'>tmpBuf</span>
<a name="line-349"></a> <span class='hs-keyword'>where</span>
<a name="line-350"></a> <span class='hs-varid'>gt</span>  <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GT</span>
<a name="line-351"></a> <span class='hs-varid'>gte</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>LT</span>
<a name="line-352"></a><span class='hs-comment'>{-# INLINE merge #-}</span>
</pre></body>
</html>
