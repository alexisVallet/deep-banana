<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/DeepBanana/Tensor.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE DeriveGeneric, UndecidableInstances #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies, BangPatterns #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes, AllowAmbiguousTypes #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-|
<a name="line-5"></a>GPU multi-dimensional dense numeric arrays.
<a name="line-6"></a>-}</span>
<a name="line-7"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span> <span class='hs-layout'>(</span>
<a name="line-8"></a>    <span class='hs-keyword'>module</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Shape</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-10"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>TensorScalar</span>
<a name="line-11"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-comment'>-- * Basic manipulations</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>dtype</span>
<a name="line-14"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>reshape</span>
<a name="line-15"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>reshape'</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shapeConvert</span>
<a name="line-17"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>liftFixed1</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>liftFixed2</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>transfer</span>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>transfer'</span>
<a name="line-21"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>broadcast</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>broadcast'</span>
<a name="line-23"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>zeros</span>
<a name="line-24"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>zeros'</span>
<a name="line-25"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ones</span>
<a name="line-26"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ones'</span>
<a name="line-27"></a>  <span class='hs-comment'>-- * Converting from/to mutable tensors</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeFreeze</span>
<a name="line-29"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeThaw</span>
<a name="line-30"></a>  <span class='hs-comment'>-- * Converting from/to lists</span>
<a name="line-31"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tensorFromList</span>
<a name="line-32"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tensorFromList'</span>
<a name="line-33"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tensorToList</span>
<a name="line-34"></a>  <span class='hs-comment'>-- * Converting from/to storable vectors</span>
<a name="line-35"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fromVector</span>
<a name="line-36"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fromVector'</span>
<a name="line-37"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>toVector</span>
<a name="line-38"></a>  <span class='hs-comment'>-- * Utilities</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tconcat</span>
<a name="line-40"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tconcat'</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tsplitAt</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tsplitAt'</span>
<a name="line-43"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>elementwiseMax</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>flatten</span>
<a name="line-45"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Serialize</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialize</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>SV</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>SMV</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unsafe</span><span class='hs-varop'>.</span><span class='hs-conid'>Coerce</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Device</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Device</span><span class='hs-varop'>.</span><span class='hs-conid'>CuDNN</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>CuDNN</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Device</span><span class='hs-varop'>.</span><span class='hs-conid'>CUDA</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>CUDA</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Prelude</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>MT</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span> <span class='hs-layout'>(</span><span class='hs-conid'>MTensor</span><span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>Shape</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Tensor</span><span class='hs-varop'>.</span><span class='hs-conid'>TensorScalar</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DeepBanana</span><span class='hs-varop'>.</span><span class='hs-conid'>Weights</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="Tensor"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tensor</span> <span class='hs-layout'>{</span>
<a name="line-67"></a>    <span class='hs-varid'>shape</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>dataptr</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="instance%20Eq%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-72"></a>  <span class='hs-varid'>t1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t2</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="instance%20Serialize%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-75"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Serialize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-76"></a>  <span class='hs-varid'>put</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-77"></a>    <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span>
<a name="line-78"></a>    <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t</span>
<a name="line-79"></a>  <span class='hs-varid'>get</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-80"></a>    <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>get</span>
<a name="line-81"></a>    <span class='hs-varid'>tlist</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>get</span>
<a name="line-82"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tensorFromList'</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>tlist</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="instance%20NFData%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>NFData</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>NFData</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-85"></a>  <span class='hs-varid'>rnf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnf</span> <span class='hs-varid'>s</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="instance%20Show%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-88"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-89"></a>  <span class='hs-varid'>show</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Tensor "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span>  <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-90"></a>           <span class='hs-varop'>++</span> <span class='hs-str'>" "</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-num'>10</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="reshape"></a><span class='hs-comment'>-- | Reshaping.</span>
<a name="line-93"></a><span class='hs-definition'>reshape</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span>
<a name="line-94"></a>            <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleSize</span><span class='hs-layout'>)</span>
<a name="line-95"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-definition'>reshape</span> <span class='hs-varid'>newshp</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>oldshp</span> <span class='hs-varid'>dataptr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-97"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varid'>newshp</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>size</span> <span class='hs-varid'>oldshp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwVariant</span> <span class='hs-varop'>$</span> <span class='hs-varid'>incompatibleSize</span> <span class='hs-varop'>$</span>
<a name="line-98"></a>    <span class='hs-str'>"Couldn't reshape tensor from shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>oldshp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>newshp</span> <span class='hs-varop'>++</span> <span class='hs-str'>": incompatible sizes "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varid'>oldshp</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varid'>newshp</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>newshp</span> <span class='hs-varid'>dataptr</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="reshape'"></a><span class='hs-definition'>reshape'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span>
<a name="line-102"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-103"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span>
<a name="line-104"></a><span class='hs-definition'>reshape'</span> <span class='hs-varid'>newshp</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span>
<a name="line-105"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>reshape</span> <span class='hs-varid'>newshp</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>IncompatibleSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="shapeConvert"></a><span class='hs-definition'>shapeConvert</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>d</span> <span class='hs-varid'>l</span> <span class='hs-varid'>a</span> <span class='hs-varid'>m</span> <span class='hs-varid'>t</span>
<a name="line-108"></a>             <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>)</span>
<a name="line-109"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-definition'>shapeConvert</span> <span class='hs-varid'>outshp</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>datafptr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-111"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dimensions</span> <span class='hs-varid'>outshp</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>dimensions</span> <span class='hs-varid'>shp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwVariant</span> <span class='hs-varop'>$</span> <span class='hs-varid'>incompatibleShape</span> <span class='hs-varop'>$</span>
<a name="line-112"></a>    <span class='hs-str'>"Cannot convert tensor from dynamic shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>shp</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to fixed shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>outshp</span>
<a name="line-113"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>outshp</span> <span class='hs-varid'>datafptr</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="liftFixed1"></a><span class='hs-definition'>liftFixed1</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span>
<a name="line-116"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span>
<a name="line-117"></a><span class='hs-definition'>liftFixed1</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-varid'>eres</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>
<a name="line-119"></a>    <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>IncompatibleShape</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-120"></a>    <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-121"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>toAnyFixed</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>of</span>
<a name="line-122"></a>       <span class='hs-conid'>AnyFixed</span> <span class='hs-varid'>fshp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-123"></a>         <span class='hs-varid'>fx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shapeConvert</span> <span class='hs-varid'>fshp</span> <span class='hs-varid'>x</span>
<a name="line-124"></a>         <span class='hs-varid'>shapeConvert</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>f</span> <span class='hs-varid'>fx</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="instance%20FixShape%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FixShape</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-127"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>FixScalar</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span>
<a name="line-128"></a>  <span class='hs-varid'>liftVec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftFixed2</span>
<a name="line-129"></a>  
<a name="line-130"></a><a name="liftFixed2"></a><span class='hs-definition'>liftFixed2</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>)</span>
<a name="line-131"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-132"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-definition'>liftFixed2</span> <span class='hs-varid'>g</span> <span class='hs-varid'>x1</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-134"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>toAnyFixed</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>x1</span> <span class='hs-keyword'>of</span>
<a name="line-135"></a>   <span class='hs-conid'>AnyFixed</span> <span class='hs-varid'>fshp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-136"></a>     <span class='hs-varid'>fx1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shapeConvert</span> <span class='hs-varid'>fshp</span> <span class='hs-varid'>x1</span>
<a name="line-137"></a>     <span class='hs-varid'>fx2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shapeConvert</span> <span class='hs-varid'>fshp</span> <span class='hs-varid'>x2</span>
<a name="line-138"></a>     <span class='hs-varid'>shapeConvert</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>x1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>g</span> <span class='hs-varid'>fx1</span> <span class='hs-varid'>fx2</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="instance%20DeviceTransfer%20(Tensor%20d1%20s%20a)%20(Tensor%20d2%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Device</span> <span class='hs-varid'>d2</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-141"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DeviceTransfer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-142"></a>  <span class='hs-varid'>transfer</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-143"></a>    <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span>
<a name="line-144"></a>    <span class='hs-varid'>mt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-varid'>mt</span>
<a name="line-145"></a>    <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>mt'</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="dtype"></a><span class='hs-comment'>-- | Returns the CuDNN datatype of a tensor.</span>
<a name="line-148"></a><span class='hs-definition'>dtype</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CuDNN</span><span class='hs-varop'>.</span><span class='hs-conid'>DataType</span>
<a name="line-149"></a><span class='hs-definition'>dtype</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>datatype</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="unsafeFreeze"></a><span class='hs-comment'>-- | Converts a mutable tensor into an immutable one in O(1) time. The data is not</span>
<a name="line-152"></a><span class='hs-comment'>-- copied, so one should make sure the input mutable tensor is not modified after the</span>
<a name="line-153"></a><span class='hs-comment'>-- the conversion. Unsafe.</span>
<a name="line-154"></a><span class='hs-definition'>unsafeFreeze</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MTensor</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-155"></a><span class='hs-definition'>unsafeFreeze</span> <span class='hs-layout'>(</span><span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-conid'>MTensor</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>ptr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>ptr</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="unsafeThaw"></a><span class='hs-comment'>-- | Converts an immutable tensor into a mutable one in O(1) time. The data is not</span>
<a name="line-158"></a><span class='hs-comment'>-- copied, so one should make sure the input immutable tensor is not used after the</span>
<a name="line-159"></a><span class='hs-comment'>-- conversion. Unsafe.</span>
<a name="line-160"></a><span class='hs-definition'>unsafeThaw</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>MTensor</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-161"></a><span class='hs-definition'>unsafeThaw</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>ptr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-conid'>MTensor</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>ptr</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="zeros"></a><span class='hs-comment'>-- | Initializes a tensor with all zeros.</span>
<a name="line-164"></a><span class='hs-definition'>zeros</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-165"></a>          <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-166"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-167"></a><span class='hs-definition'>zeros</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-168"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>zeros</span> <span class='hs-varid'>shp</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>unsafeFreeze</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="zeros'"></a><span class='hs-definition'>zeros'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-171"></a>       <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-172"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-173"></a><span class='hs-definition'>zeros'</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeros</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="ones"></a><span class='hs-comment'>-- | Initializes a tensor with all ones.</span>
<a name="line-176"></a><span class='hs-definition'>ones</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-177"></a>         <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-178"></a>     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-179"></a><span class='hs-definition'>ones</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-180"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>ones</span> <span class='hs-varid'>shp</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>unsafeFreeze</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="ones'"></a><span class='hs-definition'>ones'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-183"></a>      <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>  <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-184"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-185"></a><span class='hs-definition'>ones'</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>ones</span> <span class='hs-varid'>shp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="tensorFromList"></a><span class='hs-comment'>-- | Initializes a tensor from list data. If the length of the list does not correspond</span>
<a name="line-188"></a><span class='hs-comment'>-- to the size of the desired shape, throws an exception at run time.</span>
<a name="line-189"></a><span class='hs-definition'>tensorFromList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                   <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleSize</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-191"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-definition'>tensorFromList</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-193"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>tensorFromList</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>value</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>unsafeFreeze</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="tensorFromList'"></a><span class='hs-definition'>tensorFromList'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-196"></a>                <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-197"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-198"></a><span class='hs-definition'>tensorFromList'</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span>
<a name="line-199"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>tensorFromList</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>value</span>
<a name="line-200"></a>                   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coproduct</span> <span class='hs-chr'>'</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>IncompatibleSize</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a><a name="tensorToList"></a><span class='hs-comment'>-- | Converts a tensor to a list.</span>
<a name="line-203"></a><span class='hs-definition'>tensorToList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-204"></a><span class='hs-definition'>tensorToList</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>tensorToList</span>
<a name="line-205"></a>
<a name="line-206"></a><a name="fromVector"></a><span class='hs-comment'>-- | Converts a storable vector to an immutable tensor. Throws an error at runtime</span>
<a name="line-207"></a><span class='hs-comment'>-- when the input's length does not correspond to the desired output size. Runs in</span>
<a name="line-208"></a><span class='hs-comment'>-- O(n) time.</span>
<a name="line-209"></a><span class='hs-definition'>fromVector</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-210"></a>           <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-211"></a>              <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleSize</span><span class='hs-layout'>)</span>
<a name="line-212"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SVector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-213"></a><span class='hs-definition'>fromVector</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-214"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>value</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>size</span> <span class='hs-varid'>shp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwVariant</span> <span class='hs-varop'>$</span> <span class='hs-varid'>incompatibleSize</span> <span class='hs-varop'>$</span>
<a name="line-215"></a>    <span class='hs-str'>"fromVector: Incompatible sizes\n\tinput vector: "</span>
<a name="line-216"></a>    <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n\trequired output shape: "</span>
<a name="line-217"></a>    <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>shp</span>
<a name="line-218"></a>    <span class='hs-varop'>++</span> <span class='hs-str'>", size "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varid'>shp</span><span class='hs-layout'>)</span>
<a name="line-219"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-220"></a>    <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTensor</span> <span class='hs-varid'>shp</span>
<a name="line-221"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWith</span> <span class='hs-varid'>value</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>vptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-222"></a>      <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-223"></a>        <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>pokeArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varid'>shp</span><span class='hs-layout'>)</span> <span class='hs-varid'>vptr</span> <span class='hs-varid'>resptr</span>
<a name="line-224"></a>    <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="fromVector'"></a><span class='hs-definition'>fromVector'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-227"></a>            <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-228"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SVector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-229"></a><span class='hs-definition'>fromVector'</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span>
<a name="line-230"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromVector</span> <span class='hs-varid'>shp</span> <span class='hs-varid'>value</span>
<a name="line-231"></a>                   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coproduct</span> <span class='hs-chr'>'</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>,</span> <span class='hs-conid'>IncompatibleSize</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="toVector"></a><span class='hs-comment'>-- | Converts a tensor to a storable vector. Runs in O(n) time.</span>
<a name="line-234"></a><span class='hs-definition'>toVector</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-235"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SVector</span> <span class='hs-varid'>a</span>
<a name="line-236"></a><span class='hs-definition'>toVector</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-237"></a>  <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>SMV</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span>
<a name="line-238"></a>  <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span>
<a name="line-239"></a>  <span class='hs-conid'>SMV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWith</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-240"></a>    <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mtptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-241"></a>      <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>peekArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>mtptr</span> <span class='hs-varid'>resptr</span>
<a name="line-242"></a>  <span class='hs-conid'>SV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="tconcat"></a><span class='hs-comment'>-- | Concatenates two 1-dimensional tensors. Inverse of tsplit. Runs in O(n+m) time.</span>
<a name="line-245"></a><span class='hs-definition'>tconcat</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>d</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-246"></a>        <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-247"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-248"></a><span class='hs-definition'>tconcat</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-249"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-250"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>t1sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span>
<a name="line-251"></a>        <span class='hs-varid'>t2sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t2</span>
<a name="line-252"></a>    <span class='hs-varid'>out</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTensor</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1sz</span> <span class='hs-varop'>+</span> <span class='hs-varid'>t2sz</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Z</span>
<a name="line-253"></a>    <span class='hs-varid'>mt1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t1</span>
<a name="line-254"></a>    <span class='hs-varid'>mt2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t2</span>
<a name="line-255"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t1ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-256"></a>      <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t2ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-257"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>out</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>outptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-258"></a>          <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>copyArray</span> <span class='hs-varid'>t1sz</span> <span class='hs-varid'>t1ptr</span> <span class='hs-varid'>outptr</span>
<a name="line-259"></a>          <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>copyArray</span> <span class='hs-varid'>t2sz</span> <span class='hs-varid'>t2ptr</span>
<a name="line-260"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-conid'>DevicePtr</span>
<a name="line-261"></a>             <span class='hs-varop'>$</span> <span class='hs-varid'>plusPtr</span>
<a name="line-262"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>useDevicePtr</span> <span class='hs-varid'>outptr</span><span class='hs-layout'>)</span>
<a name="line-263"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mySizeOf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>t1sz</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-264"></a>    <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>out</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="tconcat'"></a><span class='hs-definition'>tconcat'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span>
<a name="line-267"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-268"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-269"></a><span class='hs-definition'>tconcat'</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span>
<a name="line-270"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>tconcat</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-271"></a>
<a name="line-272"></a><a name="tsplitAt"></a><span class='hs-comment'>-- | Splits a 1-dimensional tensor into 2 parts. Inverse of tconcat. Runs in O(n+m) time.</span>
<a name="line-273"></a><span class='hs-definition'>tsplitAt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>d</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-274"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>,</span>
<a name="line-275"></a>            <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleSize</span><span class='hs-layout'>)</span>
<a name="line-276"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-277"></a><span class='hs-definition'>tsplitAt</span> <span class='hs-varid'>t1sz</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-278"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>t2sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-varid'>t1sz</span>
<a name="line-279"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2sz</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwVariant</span> <span class='hs-varop'>$</span> <span class='hs-varid'>incompatibleSize</span> <span class='hs-varop'>$</span>
<a name="line-280"></a>    <span class='hs-str'>"Couldn't split the a vector of size "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" at point "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>t1sz</span> <span class='hs-varop'>++</span> <span class='hs-str'>" : the input vector is too small."</span>
<a name="line-281"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-282"></a>    <span class='hs-varid'>mt1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTensor</span> <span class='hs-varop'>$</span> <span class='hs-varid'>t1sz</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Z</span>
<a name="line-283"></a>    <span class='hs-varid'>mt2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTensor</span> <span class='hs-varop'>$</span> <span class='hs-varid'>t2sz</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Z</span>
<a name="line-284"></a>    <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span>
<a name="line-285"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t1ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-286"></a>      <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t2ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-287"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mt</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-288"></a>          <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>copyArray</span> <span class='hs-varid'>t1sz</span> <span class='hs-varid'>tptr</span> <span class='hs-varid'>t1ptr</span>
<a name="line-289"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>offsetPtr</span> <span class='hs-keyglyph'>=</span>
<a name="line-290"></a>                <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-conid'>DevicePtr</span>
<a name="line-291"></a>                <span class='hs-varop'>$</span> <span class='hs-varid'>plusPtr</span>
<a name="line-292"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>useDevicePtr</span> <span class='hs-varid'>tptr</span><span class='hs-layout'>)</span>
<a name="line-293"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>mySizeOf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>t1sz</span><span class='hs-layout'>)</span>
<a name="line-294"></a>          <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>copyArray</span> <span class='hs-varid'>t2sz</span> <span class='hs-varid'>offsetPtr</span> <span class='hs-varid'>t2ptr</span>
<a name="line-295"></a>    <span class='hs-varid'>pure</span> <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>mt1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>mt2</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="tsplitAt'"></a><span class='hs-definition'>tsplitAt'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span>
<a name="line-298"></a>          <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-299"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-300"></a><span class='hs-definition'>tsplitAt'</span> <span class='hs-varid'>t1sz</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>tsplitAt</span> <span class='hs-varid'>t1sz</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coproduct</span> <span class='hs-chr'>'</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>,</span><span class='hs-conid'>IncompatibleSize</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="flatten"></a><span class='hs-comment'>-- | Flattens a tensor into a 1-dimensional vector.</span>
<a name="line-303"></a><span class='hs-definition'>flatten</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span>
<a name="line-304"></a>        <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-305"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-306"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span>
<a name="line-307"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>reshape</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Z</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span>
<a name="line-308"></a>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>IncompatibleSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dim</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-309"></a>   <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Couldn't flatten a tensor. This shouldn't happen.\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>err</span>
<a name="line-310"></a>   <span class='hs-conid'>Right</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="broadcast"></a><span class='hs-comment'>-- | Type-safe broadcasting.</span>
<a name="line-313"></a><span class='hs-definition'>broadcast</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>t</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-314"></a>          <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-315"></a>             <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-316"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-317"></a><span class='hs-definition'>broadcast</span> <span class='hs-varid'>outshp</span> <span class='hs-varid'>inp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-318"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>broadcastable</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span> <span class='hs-varid'>outshp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwVariant</span> <span class='hs-varop'>$</span> <span class='hs-varid'>incompatibleShape</span> <span class='hs-varop'>$</span>
<a name="line-319"></a>    <span class='hs-str'>"Couldn't broadcast shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to shape "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>outshp</span>
<a name="line-320"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>inp_shape</span> <span class='hs-keyglyph'>=</span>
<a name="line-321"></a>          <span class='hs-varid'>fmap</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-322"></a>          <span class='hs-varop'>$</span> <span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>nbdim</span> <span class='hs-varid'>outshp</span> <span class='hs-comment'>-</span> <span class='hs-varid'>nbdim</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-323"></a>          <span class='hs-varop'>++</span> <span class='hs-varid'>dimensions</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span>
<a name="line-324"></a>      <span class='hs-varid'>out_shape</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dimensions</span> <span class='hs-varid'>outshp</span>
<a name="line-325"></a>      <span class='hs-varid'>inp_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>inp</span>
<a name="line-326"></a>      <span class='hs-varid'>out_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varid'>outshp</span>
<a name="line-327"></a>      <span class='hs-varid'>out_nbdim</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nbdim</span> <span class='hs-varid'>outshp</span>
<a name="line-328"></a>  <span class='hs-comment'>-- We avoid copying when the size doesn't change.</span>
<a name="line-329"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>out_size</span> <span class='hs-varop'>==</span> <span class='hs-varid'>inp_size</span>
<a name="line-330"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reshape'</span> <span class='hs-varid'>outshp</span> <span class='hs-varid'>inp</span>
<a name="line-331"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-332"></a>    <span class='hs-varid'>minp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>inp</span>
<a name="line-333"></a>    <span class='hs-varid'>mout</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTensor</span> <span class='hs-varid'>outshp</span>
<a name="line-334"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>minp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>inpptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-335"></a>      <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mout</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>outptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-336"></a>        <span class='hs-varid'>inp_shapeptr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>newListArray</span> <span class='hs-varid'>inp_shape</span>
<a name="line-337"></a>        <span class='hs-varid'>out_shapeptr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>newListArray</span> <span class='hs-varid'>out_shape</span>
<a name="line-338"></a>        <span class='hs-varid'>broadcast_copy</span> <span class='hs-varid'>out_nbdim</span> <span class='hs-varid'>out_size</span> <span class='hs-varid'>inpptr</span> <span class='hs-varid'>inp_shapeptr</span> <span class='hs-varid'>outptr</span> <span class='hs-varid'>out_shapeptr</span>
<a name="line-339"></a>        <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>free</span> <span class='hs-varid'>inp_shapeptr</span>
<a name="line-340"></a>        <span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-varid'>free</span> <span class='hs-varid'>out_shapeptr</span>
<a name="line-341"></a>    <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>mout</span>
<a name="line-342"></a>
<a name="line-343"></a><a name="broadcast'"></a><span class='hs-definition'>broadcast'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span>
<a name="line-344"></a>           <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-345"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span>
<a name="line-346"></a><span class='hs-definition'>broadcast'</span> <span class='hs-varid'>outshp</span> <span class='hs-varid'>inp</span> <span class='hs-keyglyph'>=</span>
<a name="line-347"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>broadcast</span> <span class='hs-varid'>outshp</span> <span class='hs-varid'>inp</span>
<a name="line-348"></a>                   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coproduct</span> <span class='hs-chr'>'</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-349"></a>
<a name="line-350"></a><a name="bin_broadcast"></a><span class='hs-definition'>bin_broadcast</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-351"></a>              <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-352"></a>                 <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>)</span>
<a name="line-353"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-354"></a><span class='hs-definition'>bin_broadcast</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span>
<a name="line-355"></a>  <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>broadcast</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>broadcast</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-356"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>err1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>err2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwError</span> <span class='hs-varid'>err1</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>throwError</span> <span class='hs-varid'>err2</span>
<a name="line-357"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>t1'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-358"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>err</span><span class='hs-layout'>,</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span>
<a name="line-359"></a>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-360"></a>
<a name="line-361"></a><a name="bin_broadcast'"></a><span class='hs-definition'>bin_broadcast'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-362"></a>               <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-363"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-364"></a><span class='hs-definition'>bin_broadcast'</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span>
<a name="line-365"></a>  <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>bin_broadcast</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-366"></a>                   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coproduct</span> <span class='hs-chr'>'</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-367"></a>
<a name="line-368"></a><a name="instance%20Num%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-369"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-370"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Num</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-371"></a>  <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-372"></a>    <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-373"></a>      <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t1</span>
<a name="line-374"></a>      <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t2</span>
<a name="line-375"></a>      <span class='hs-varid'>t3'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-varid'>t2'</span>
<a name="line-376"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t1'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t1ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-377"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t3'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t3ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-378"></a>          <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAdd</span> <span class='hs-varid'>t1ptr</span> <span class='hs-varid'>t3ptr</span>
<a name="line-379"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span>
<a name="line-380"></a>      <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>t3'</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-381"></a>
<a name="line-382"></a>  <span class='hs-varid'>t1</span> <span class='hs-varop'>*</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> 
<a name="line-383"></a>    <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-384"></a>      <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t1</span>
<a name="line-385"></a>      <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t2</span>
<a name="line-386"></a>      <span class='hs-varid'>t3'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-varid'>t2'</span>
<a name="line-387"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t1'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t1ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-388"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t3'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t3ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-389"></a>          <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawMul</span> <span class='hs-varid'>t1ptr</span> <span class='hs-varid'>t3ptr</span>
<a name="line-390"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span>
<a name="line-391"></a>      <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>t3'</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-392"></a>
<a name="line-393"></a>  <span class='hs-varid'>t1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-394"></a>    <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-395"></a>      <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t1</span>
<a name="line-396"></a>      <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t2</span>
<a name="line-397"></a>      <span class='hs-varid'>t3'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-varid'>t2'</span>
<a name="line-398"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t1'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t1ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-399"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>t3'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t3ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-400"></a>          <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawSubtract</span> <span class='hs-varid'>t1ptr</span> <span class='hs-varid'>t3ptr</span>
<a name="line-401"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t1</span>
<a name="line-402"></a>      <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>t3'</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-403"></a>  <span class='hs-varid'>negate</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>                   <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-405"></a>                   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-406"></a>                     <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawNegate</span> <span class='hs-varid'>resptr</span>
<a name="line-407"></a>                       <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span>
<a name="line-408"></a>                   <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>in</span>
<a name="line-409"></a>              <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-410"></a>  <span class='hs-varid'>signum</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-411"></a>                   <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-412"></a>                   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-413"></a>                     <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawSignum</span> <span class='hs-varid'>resptr</span>
<a name="line-414"></a>                       <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span>
<a name="line-415"></a>                   <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>in</span>
<a name="line-416"></a>              <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-417"></a>  <span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>ones'</span> <span class='hs-varid'>scalarShape</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="instance%20Fractional%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-420"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-421"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Fractional</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-422"></a>  <span class='hs-varid'>recip</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-423"></a>                  <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-424"></a>                  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>inv</span> <span class='hs-varid'>res</span>
<a name="line-425"></a>                  <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>in</span>
<a name="line-426"></a>             <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-427"></a>  <span class='hs-varid'>fromRational</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>numerator</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>fromInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>denominator</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-428"></a>
<a name="line-429"></a><a name="elementwiseMax"></a><span class='hs-comment'>-- | Computes the elementwise maximum of 2 tensors.</span>
<a name="line-430"></a><span class='hs-definition'>elementwiseMax</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span>
<a name="line-431"></a>               <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadError</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-432"></a>                  <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>OutOfMemory</span><span class='hs-layout'>,</span> <span class='hs-conid'>Variant</span> <span class='hs-varid'>t</span> <span class='hs-conid'>IncompatibleShape</span><span class='hs-layout'>)</span>
<a name="line-433"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-434"></a><span class='hs-definition'>elementwiseMax</span> <span class='hs-sel'>_x</span> <span class='hs-sel'>_y</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-435"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bin_broadcast</span> <span class='hs-sel'>_x</span> <span class='hs-sel'>_y</span>
<a name="line-436"></a>  <span class='hs-varid'>embedExcept</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-437"></a>    <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>x</span>
<a name="line-438"></a>    <span class='hs-varid'>my</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>y</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-439"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mx</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pmx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-440"></a>      <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>my</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pmy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-441"></a>        <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawMax</span> <span class='hs-varid'>pmx</span> <span class='hs-varid'>pmy</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-442"></a>    <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>my</span>
<a name="line-443"></a>
<a name="line-444"></a><a name="fromRaw"></a><span class='hs-definition'>fromRaw</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-445"></a>        <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-446"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CUDA</span><span class='hs-varop'>.</span><span class='hs-conid'>DevicePtr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DeviceM</span> <span class='hs-varid'>d</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-447"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-448"></a><span class='hs-definition'>fromRaw</span> <span class='hs-varid'>action</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span>
<a name="line-449"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-450"></a>        <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>x</span>
<a name="line-451"></a>        <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-varid'>mx</span>
<a name="line-452"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-453"></a>          <span class='hs-varid'>action</span> <span class='hs-varid'>resptr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>x</span>
<a name="line-454"></a>        <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span>
<a name="line-455"></a>  <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-456"></a>
<a name="line-457"></a><a name="instance%20Floating%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-458"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-459"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Floating</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-460"></a>  <span class='hs-varid'>pi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pi</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>ones'</span> <span class='hs-varid'>scalarShape</span>
<a name="line-461"></a>  <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawExp</span>
<a name="line-462"></a>  <span class='hs-varid'>log</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawLog</span>
<a name="line-463"></a>  <span class='hs-varid'>sqrt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawSqrt</span>
<a name="line-464"></a>  <span class='hs-varid'>sin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawSin</span>
<a name="line-465"></a>  <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawCos</span>
<a name="line-466"></a>  <span class='hs-varid'>tan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawTan</span>
<a name="line-467"></a>  <span class='hs-varid'>asin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAsin</span>
<a name="line-468"></a>  <span class='hs-varid'>acos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAcos</span>
<a name="line-469"></a>  <span class='hs-varid'>atan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAtan</span>
<a name="line-470"></a>  <span class='hs-varid'>sinh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawSinh</span>
<a name="line-471"></a>  <span class='hs-varid'>cosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawCosh</span>
<a name="line-472"></a>  <span class='hs-varid'>tanh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawTanh</span>
<a name="line-473"></a>  <span class='hs-varid'>asinh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAsinh</span>
<a name="line-474"></a>  <span class='hs-varid'>acosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAcosh</span>
<a name="line-475"></a>  <span class='hs-varid'>atanh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRaw</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawAtanh</span>
<a name="line-476"></a>  <span class='hs-sel'>_x</span><span class='hs-varop'>**</span><span class='hs-sel'>_y</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bin_broadcast'</span> <span class='hs-sel'>_x</span> <span class='hs-sel'>_y</span>
<a name="line-477"></a>               <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-478"></a>                 <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>x</span>
<a name="line-479"></a>                 <span class='hs-varid'>my</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>y</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-480"></a>                 <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>mx</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pmx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-481"></a>                   <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>my</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pmy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-482"></a>                     <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawPow</span> <span class='hs-varid'>pmx</span> <span class='hs-varid'>pmy</span>
<a name="line-483"></a>                       <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>x</span>
<a name="line-484"></a>                 <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>my</span>
<a name="line-485"></a>           <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-486"></a>
<a name="line-487"></a><a name="instance%20AdditiveGroup%20(Tensor%20d%20s%20a)"></a><span class='hs-comment'>-- Vector space instance for Tensors.</span>
<a name="line-488"></a><a name="instance%20AdditiveGroup%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-489"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AdditiveGroup</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-490"></a>  <span class='hs-varid'>zeroV</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromInteger</span> <span class='hs-num'>0</span>
<a name="line-491"></a>  <span class='hs-varid'>t1</span> <span class='hs-varop'>^+^</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>t2</span>
<a name="line-492"></a>  <span class='hs-varid'>negateV</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>negate</span> <span class='hs-varid'>t</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="instance%20VectorSpace%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-495"></a>         <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-496"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>VectorSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-497"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Scalar</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span>
<a name="line-498"></a>  <span class='hs-varid'>x</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-499"></a>                 <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsafeThaw</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span>
<a name="line-500"></a>                 <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>withDevicePtr</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>resptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runDeviceM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-501"></a>                   <span class='hs-conid'>MT</span><span class='hs-varop'>.</span><span class='hs-varid'>rawScale</span> <span class='hs-varid'>x</span> <span class='hs-varid'>resptr</span>
<a name="line-502"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>t</span>
<a name="line-503"></a>                 <span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>res</span>
<a name="line-504"></a>           <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeRunExcept</span> <span class='hs-layout'>(</span><span class='hs-varid'>eres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>OutOfMemory</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-505"></a>
<a name="line-506"></a><a name="instance%20InnerSpace%20(Tensor%20d%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Device</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsFixed</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>TensorScalar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-507"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>InnerSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tensor</span> <span class='hs-varid'>d</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-508"></a>  <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-layout'>,</span><span class='hs-varid'>x2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x1</span> <span class='hs-varop'>*</span> <span class='hs-varid'>x2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tensorToList</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
</pre></body>
</html>
