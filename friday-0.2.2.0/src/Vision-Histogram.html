<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Vision/Histogram.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns
<a name="line-2"></a>           , FlexibleContexts
<a name="line-3"></a>           , FlexibleInstances
<a name="line-4"></a>           , ParallelListComp
<a name="line-5"></a>           , TypeFamilies
<a name="line-6"></a>           , TypeOperators #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- | Contains functions to compute and manipulate histograms as well as some</span>
<a name="line-10"></a><span class='hs-comment'>-- images transformations which are histogram-based.</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>-- Every polymorphic function is specialised for histograms of 'Int32', 'Double'</span>
<a name="line-13"></a><span class='hs-comment'>-- and 'Float'. Other types can be specialized as every polymorphic function is</span>
<a name="line-14"></a><span class='hs-comment'>-- declared @INLINABLE@.</span>
<a name="line-15"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span>
<a name="line-16"></a>    <span class='hs-comment'>-- * Types &amp; helpers</span>
<a name="line-17"></a>      <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>index</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>linearIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span><span class='hs-layout'>,</span> <span class='hs-varid'>assocs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pixToBin</span>
<a name="line-19"></a>    <span class='hs-comment'>-- * Histogram computations</span>
<a name="line-20"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>histogram</span><span class='hs-layout'>,</span>  <span class='hs-varid'>histogram2D</span><span class='hs-layout'>,</span> <span class='hs-varid'>reduce</span><span class='hs-layout'>,</span> <span class='hs-varid'>resize</span><span class='hs-layout'>,</span> <span class='hs-varid'>cumulative</span><span class='hs-layout'>,</span> <span class='hs-varid'>normalize</span>
<a name="line-21"></a>    <span class='hs-comment'>-- * Images processing</span>
<a name="line-22"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>equalizeImage</span>
<a name="line-23"></a>    <span class='hs-comment'>-- * Histogram comparisons</span>
<a name="line-24"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>compareCorrel</span><span class='hs-layout'>,</span> <span class='hs-varid'>compareChi</span><span class='hs-layout'>,</span> <span class='hs-varid'>compareIntersect</span><span class='hs-layout'>,</span> <span class='hs-varid'>compareEMD</span>
<a name="line-25"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Int</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vector</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Storable</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>V</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pixel</span><span class='hs-layout'>,</span> <span class='hs-conid'>MaskedImage</span><span class='hs-layout'>,</span> <span class='hs-conid'>Image</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImagePixel</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunctorImage</span><span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>Grey</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-conid'>GreyPixel</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>HSV</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>  <span class='hs-layout'>(</span><span class='hs-conid'>HSVPixel</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>RGBA</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-conid'>RGBAPixel</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>RGB</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>  <span class='hs-layout'>(</span><span class='hs-conid'>RGBPixel</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Primitive</span> <span class='hs-layout'>(</span>
<a name="line-40"></a>      <span class='hs-conid'>Z</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conop'>:.</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DIM1</span><span class='hs-layout'>,</span> <span class='hs-conid'>DIM3</span><span class='hs-layout'>,</span> <span class='hs-conid'>DIM4</span><span class='hs-layout'>,</span> <span class='hs-conid'>DIM5</span><span class='hs-layout'>,</span> <span class='hs-varid'>ix1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ix3</span><span class='hs-layout'>,</span> <span class='hs-varid'>ix4</span>
<a name="line-41"></a>    <span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Vision</span><span class='hs-varop'>.</span><span class='hs-conid'>Image</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>I</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>-- There is no rule to simplify the conversion from Int32 to Double and Float</span>
<a name="line-46"></a><span class='hs-comment'>-- when using realToFrac. Both conversions are using a temporary yet useless</span>
<a name="line-47"></a><span class='hs-comment'>-- Rational value.</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-comment'>{-# RULES
<a name="line-50"></a>"realToFrac/Int32-&gt;Double" realToFrac = fromIntegral :: Int32 -&gt; Double
<a name="line-51"></a>"realToFrac/Int32-&gt;Float"  realToFrac = fromIntegral :: Int32 -&gt; Float
<a name="line-52"></a>  #-}</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>-- Types -----------------------------------------------------------------------</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="Histogram"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>{</span>
<a name="line-57"></a>      <span class='hs-varid'>shape</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-varid'>sh</span>
<a name="line-58"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>vector</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Values of the histogram in row-major order.</span>
<a name="line-59"></a>    <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="HistogramShape"></a><span class='hs-comment'>-- | Subclass of 'Shape' which defines how to resize a shape so it will fit</span>
<a name="line-62"></a><a name="HistogramShape"></a><span class='hs-comment'>-- inside a resized histogram.</span>
<a name="line-63"></a><a name="HistogramShape"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-varid'>sh</span> <span class='hs-keyword'>where</span>
<a name="line-64"></a>    <span class='hs-comment'>-- | Given a number of bins of an histogram, reduces an index so it will be</span>
<a name="line-65"></a>    <span class='hs-comment'>-- mapped to a bin.</span>
<a name="line-66"></a>    <span class='hs-varid'>toBin</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>sh</span> <span class='hs-comment'>-- ^ The number of bins we are mapping to.</span>
<a name="line-67"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-comment'>-- ^ The number of possible values of the original index.</span>
<a name="line-68"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-comment'>-- ^ The original index.</span>
<a name="line-69"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-comment'>-- ^ The index of the bin in the histogram.</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="instance%20HistogramShape%20Z"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-conid'>Z</span> <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>toBin</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Z</span>
<a name="line-73"></a>    <span class='hs-comment'>{-# INLINE toBin #-}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="instance%20HistogramShape%20(sh%20:.%20Int)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-varid'>sh</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-layout'>(</span><span class='hs-varid'>sh</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>toBin</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>shBins</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>bins</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>shMaxBins</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>maxBins</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>shIx</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>ix</span><span class='hs-layout'>)</span>
<a name="line-77"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bins</span> <span class='hs-varop'>==</span> <span class='hs-varid'>maxBins</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>ix</span>
<a name="line-78"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner</span> <span class='hs-conop'>:.</span> <span class='hs-layout'>(</span><span class='hs-varid'>ix</span> <span class='hs-varop'>*</span> <span class='hs-varid'>bins</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>maxBins</span><span class='hs-layout'>)</span>
<a name="line-79"></a>      <span class='hs-keyword'>where</span>
<a name="line-80"></a>        <span class='hs-varid'>inner</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBin</span> <span class='hs-varid'>shBins</span> <span class='hs-varid'>shMaxBins</span> <span class='hs-varid'>shIx</span>
<a name="line-81"></a>    <span class='hs-comment'>{-# INLINE toBin #-}</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="ToHistogram"></a><span class='hs-comment'>-- | This class defines how many dimensions a histogram will have and what will</span>
<a name="line-84"></a><a name="ToHistogram"></a><span class='hs-comment'>-- be the default number of bins.</span>
<a name="line-85"></a><a name="ToHistogram"></a><span class='hs-keyword'>class</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pixel</span> <span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-conid'>Shape</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>where</span>
<a name="line-86"></a>    <span class='hs-comment'>-- | Gives the value space of a pixel. Single-channel pixels will be 'DIM1'</span>
<a name="line-87"></a>    <span class='hs-comment'>-- whereas three-channels pixels will be 'DIM3'.</span>
<a name="line-88"></a>    <span class='hs-comment'>-- This is used to determine the rank of the generated histogram.</span>
<a name="line-89"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>-- | Converts a pixel to an index.</span>
<a name="line-92"></a>    <span class='hs-varid'>pixToIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-comment'>-- | Returns the maximum number of different values an index can take for</span>
<a name="line-95"></a>    <span class='hs-comment'>-- each dimension of the histogram (aka. the maximum index returned by</span>
<a name="line-96"></a>    <span class='hs-comment'>-- 'pixToIndex' plus one).</span>
<a name="line-97"></a>    <span class='hs-varid'>domainSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="instance%20ToHistogram%20GreyPixel"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-conid'>GreyPixel</span> <span class='hs-keyword'>where</span>
<a name="line-100"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-conid'>GreyPixel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DIM1</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-varid'>pixToIndex</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>GreyPixel</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix1</span> <span class='hs-varop'>$</span> <span class='hs-varid'>int</span> <span class='hs-varid'>val</span>
<a name="line-103"></a>    <span class='hs-comment'>{-# INLINE pixToIndex #-}</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-varid'>domainSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix1</span> <span class='hs-num'>256</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="instance%20ToHistogram%20RGBAPixel"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-conid'>RGBAPixel</span> <span class='hs-keyword'>where</span>
<a name="line-108"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-conid'>RGBAPixel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DIM4</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class='hs-varid'>pixToIndex</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>RGBAPixel</span> <span class='hs-varid'>r</span> <span class='hs-varid'>g</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix4</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-111"></a>    <span class='hs-comment'>{-# INLINE pixToIndex #-}</span>
<a name="line-112"></a>
<a name="line-113"></a>    <span class='hs-varid'>domainSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix4</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="instance%20ToHistogram%20RGBPixel"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-conid'>RGBPixel</span> <span class='hs-keyword'>where</span>
<a name="line-116"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-conid'>RGBPixel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DIM3</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-varid'>pixToIndex</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>RGBPixel</span> <span class='hs-varid'>r</span> <span class='hs-varid'>g</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix3</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-119"></a>    <span class='hs-comment'>{-# INLINE pixToIndex #-}</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-varid'>domainSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix3</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="instance%20ToHistogram%20HSVPixel"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-conid'>HSVPixel</span> <span class='hs-keyword'>where</span>
<a name="line-124"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-conid'>HSVPixel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DIM3</span>
<a name="line-125"></a>
<a name="line-126"></a>    <span class='hs-varid'>pixToIndex</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>HSVPixel</span> <span class='hs-varid'>h</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix3</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-127"></a>    <span class='hs-comment'>{-# INLINE pixToIndex #-}</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class='hs-varid'>domainSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ix3</span> <span class='hs-num'>180</span> <span class='hs-num'>256</span> <span class='hs-num'>256</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-comment'>-- Functions -------------------------------------------------------------------</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="index"></a><span class='hs-definition'>index</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-134"></a><a name="!"></a><span class='hs-definition'>index</span> <span class='hs-varop'>!</span><span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>linearIndex</span> <span class='hs-varid'>hist</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toLinearIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>shape</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-comment'>{-# INLINE index #-}</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-comment'>-- | Alias of 'index'.</span>
<a name="line-138"></a><span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-139"></a><span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>index</span>
<a name="line-140"></a><span class='hs-comment'>{-# INLINE (!) #-}</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="linearIndex"></a><span class='hs-comment'>-- | Returns the value at the index as if the histogram was a single dimension</span>
<a name="line-143"></a><span class='hs-comment'>-- vector (row-major representation).</span>
<a name="line-144"></a><span class='hs-definition'>linearIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-145"></a><span class='hs-definition'>linearIndex</span> <span class='hs-varop'>!</span><span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.!</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>vector</span> <span class='hs-varid'>hist</span><span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-comment'>{-# INLINE linearIndex #-}</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="map"></a><span class='hs-definition'>map</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>b</span>
<a name="line-149"></a><span class='hs-definition'>map</span> <span class='hs-varid'>f</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-comment'>{-# INLINE map #-}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="assocs"></a><span class='hs-comment'>-- | Returns all index/value pairs from the histogram.</span>
<a name="line-153"></a><span class='hs-definition'>assocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-154"></a><span class='hs-definition'>assocs</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>ix</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shapeList</span> <span class='hs-varid'>sh</span>
<a name="line-155"></a>                                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>vec</span> <span class='hs-keyglyph'>]</span>
<a name="line-156"></a><span class='hs-comment'>{-# INLINE assocs #-}</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="pixToBin"></a><span class='hs-comment'>-- | Given the number of bins of an histogram and a given pixel, returns the</span>
<a name="line-159"></a><span class='hs-comment'>-- corresponding bin.</span>
<a name="line-160"></a><span class='hs-definition'>pixToBin</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>HistogramShape</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-161"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-varid'>p</span>
<a name="line-162"></a><span class='hs-definition'>pixToBin</span> <span class='hs-varid'>size</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span>
<a name="line-163"></a>    <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>domain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>domainSize</span> <span class='hs-varid'>p</span>
<a name="line-164"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>toBin</span> <span class='hs-varid'>size</span> <span class='hs-varid'>domain</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>pixToIndex</span> <span class='hs-varid'>p</span>
<a name="line-165"></a><span class='hs-comment'>{-# INLINE pixToBin #-}</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="histogram"></a><span class='hs-comment'>-- | Computes an histogram from a (possibly) multi-channel image.</span>
<a name="line-168"></a><span class='hs-comment'>--</span>
<a name="line-169"></a><span class='hs-comment'>-- If the size of the histogram is not given, there will be as many bins as the</span>
<a name="line-170"></a><span class='hs-comment'>-- range of values of pixels of the original image (see 'domainSize').</span>
<a name="line-171"></a><span class='hs-comment'>--</span>
<a name="line-172"></a><span class='hs-comment'>-- If the size of the histogram is specified, every bin of a given dimension</span>
<a name="line-173"></a><span class='hs-comment'>-- will be of the same size (uniform histogram).</span>
<a name="line-174"></a><span class='hs-definition'>histogram</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span> <span class='hs-conid'>MaskedImage</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span>
<a name="line-175"></a>             <span class='hs-layout'>,</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-176"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span>
<a name="line-177"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-178"></a><span class='hs-definition'>histogram</span> <span class='hs-varid'>mSize</span> <span class='hs-varid'>img</span> <span class='hs-keyglyph'>=</span>
<a name="line-179"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>nBins</span> <span class='hs-num'>0</span>
<a name="line-180"></a>        <span class='hs-varid'>ones</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>nPixs</span> <span class='hs-num'>1</span>
<a name="line-181"></a>        <span class='hs-varid'>ixs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIndex</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>values</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span>
<a name="line-182"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>size</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>accumulate_</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>ixs</span> <span class='hs-varid'>ones</span><span class='hs-layout'>)</span>
<a name="line-183"></a>  <span class='hs-keyword'>where</span>
<a name="line-184"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mSize</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-185"></a>                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>domainSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>pixel</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span>
<a name="line-186"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nChans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>nChannels</span> <span class='hs-varid'>img</span>
<a name="line-187"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nPixs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shapeLength</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>shape</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>nChans</span>
<a name="line-188"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nBins</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shapeLength</span> <span class='hs-varid'>size</span>
<a name="line-189"></a>
<a name="line-190"></a>    <span class='hs-varid'>toIndex</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toLinearIndex</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$!</span>
<a name="line-191"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mSize</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pixToBin</span>   <span class='hs-varid'>size</span> <span class='hs-varid'>p</span>
<a name="line-192"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pixToIndex</span> <span class='hs-varid'>p</span>
<a name="line-193"></a>    <span class='hs-comment'>{-# INLINE toIndex #-}</span>
<a name="line-194"></a><span class='hs-comment'>{-# INLINABLE histogram #-}</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="histogram2D"></a><span class='hs-comment'>-- | Similar to 'histogram' but adds two dimensions for the y and x-coordinates</span>
<a name="line-197"></a><span class='hs-comment'>-- of the sampled points. This way, the histogram will map different regions of</span>
<a name="line-198"></a><span class='hs-comment'>-- the original image.</span>
<a name="line-199"></a><span class='hs-comment'>--</span>
<a name="line-200"></a><span class='hs-comment'>-- For example, an 'RGB' image will be mapped as</span>
<a name="line-201"></a><span class='hs-comment'>-- @'Z' ':.' red channel ':.' green channel ':.' blue channel ':.' y region</span>
<a name="line-202"></a><span class='hs-comment'>-- ':.' x region@.</span>
<a name="line-203"></a><span class='hs-comment'>--</span>
<a name="line-204"></a><span class='hs-comment'>-- As there is no reason to create an histogram as large as the number of pixels</span>
<a name="line-205"></a><span class='hs-comment'>-- of the image, a size is always needed.</span>
<a name="line-206"></a><span class='hs-definition'>histogram2D</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Image</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span>
<a name="line-207"></a>               <span class='hs-layout'>,</span> <span class='hs-conid'>HistogramShape</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-208"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span>
<a name="line-209"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-210"></a><span class='hs-definition'>histogram2D</span> <span class='hs-varid'>size</span> <span class='hs-varid'>img</span> <span class='hs-keyglyph'>=</span>
<a name="line-211"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>nBins</span> <span class='hs-num'>0</span>
<a name="line-212"></a>        <span class='hs-varid'>ones</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>nPixs</span> <span class='hs-num'>1</span>
<a name="line-213"></a>        <span class='hs-varid'>imgIxs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>iterateN</span> <span class='hs-varid'>nPixs</span> <span class='hs-layout'>(</span><span class='hs-varid'>shapeSucc</span> <span class='hs-varid'>imgSize</span><span class='hs-layout'>)</span> <span class='hs-varid'>shapeZero</span>
<a name="line-214"></a>        <span class='hs-varid'>ixs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>toIndex</span> <span class='hs-varid'>imgIxs</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>vector</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span>
<a name="line-215"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>size</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>accumulate_</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>ixs</span> <span class='hs-varid'>ones</span><span class='hs-layout'>)</span>
<a name="line-216"></a>  <span class='hs-keyword'>where</span>
<a name="line-217"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>imgSize</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Z</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>shape</span> <span class='hs-varid'>img</span>
<a name="line-218"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>maxSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>domainSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>pixel</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>w</span>
<a name="line-219"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nChans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>nChannels</span> <span class='hs-varid'>img</span>
<a name="line-220"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nPixs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shapeLength</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>shape</span> <span class='hs-varid'>img</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>nChans</span>
<a name="line-221"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>nBins</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shapeLength</span> <span class='hs-varid'>size</span>
<a name="line-222"></a>
<a name="line-223"></a>    <span class='hs-varid'>toIndex</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Z</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>y</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span>
<a name="line-224"></a>        <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>ix</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pixToIndex</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>y</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>x</span>
<a name="line-225"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>toLinearIndex</span> <span class='hs-varid'>size</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>toBin</span> <span class='hs-varid'>size</span> <span class='hs-varid'>maxSize</span> <span class='hs-varid'>ix</span>
<a name="line-226"></a>    <span class='hs-comment'>{-# INLINE toIndex #-}</span>
<a name="line-227"></a><span class='hs-comment'>{-# INLINABLE histogram2D #-}</span>
<a name="line-228"></a>
<a name="line-229"></a><span class='hs-comment'>-- Reshaping -------------------------------------------------------------------</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="reduce"></a><span class='hs-comment'>-- | Reduces a 2D histogram to its linear representation. See 'resize' for a</span>
<a name="line-232"></a><span class='hs-comment'>-- reduction of the number of bins of an histogram.</span>
<a name="line-233"></a><span class='hs-comment'>--</span>
<a name="line-234"></a><span class='hs-comment'>-- @'histogram' == 'reduce' . 'histogram2D'@</span>
<a name="line-235"></a><span class='hs-definition'>reduce</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>HistogramShape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-236"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-layout'>(</span><span class='hs-varid'>sh</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span> <span class='hs-conop'>:.</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span>
<a name="line-237"></a><span class='hs-definition'>reduce</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-238"></a>    <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>sh'</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sh</span>
<a name="line-239"></a>        <span class='hs-varop'>!</span><span class='hs-varid'>len2D</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-varop'>*</span> <span class='hs-varid'>w</span>
<a name="line-240"></a>        <span class='hs-varop'>!</span><span class='hs-varid'>vec'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unfoldrN</span> <span class='hs-layout'>(</span><span class='hs-varid'>shapeLength</span> <span class='hs-varid'>sh'</span><span class='hs-layout'>)</span> <span class='hs-varid'>step</span> <span class='hs-varid'>vec</span>
<a name="line-241"></a>        <span class='hs-varid'>step</span> <span class='hs-varop'>!</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-varid'>channels</span><span class='hs-layout'>,</span> <span class='hs-varop'>!</span><span class='hs-varid'>rest'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>splitAt</span> <span class='hs-varid'>len2D</span> <span class='hs-varid'>rest</span>
<a name="line-242"></a>                     <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varid'>channels</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest'</span><span class='hs-layout'>)</span>
<a name="line-243"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh'</span> <span class='hs-varid'>vec'</span>
<a name="line-244"></a><span class='hs-comment'>{-# SPECIALIZE reduce :: Histogram DIM5 Int32  -&gt; Histogram DIM3 Int32
<a name="line-245"></a>                      ,  Histogram DIM5 Double -&gt; Histogram DIM3 Double
<a name="line-246"></a>                      ,  Histogram DIM5 Float  -&gt; Histogram DIM3 Float
<a name="line-247"></a>                      ,  Histogram DIM3 Int32  -&gt; Histogram DIM1 Int32
<a name="line-248"></a>                      ,  Histogram DIM3 Double -&gt; Histogram DIM1 Double
<a name="line-249"></a>                      ,  Histogram DIM3 Float  -&gt; Histogram DIM1 Float #-}</span>
<a name="line-250"></a><span class='hs-comment'>{-# INLINABLE reduce #-}</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="resize"></a><span class='hs-comment'>-- | Resizes an histogram to another index shape. See 'reduce' for a reduction</span>
<a name="line-253"></a><span class='hs-comment'>-- of the number of dimensions of an histogram.</span>
<a name="line-254"></a><span class='hs-definition'>resize</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>HistogramShape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-255"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>sh</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span>
<a name="line-256"></a><span class='hs-definition'>resize</span> <span class='hs-varop'>!</span><span class='hs-varid'>sh'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-257"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>shapeLength</span> <span class='hs-varid'>sh'</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>
<a name="line-258"></a>        <span class='hs-comment'>-- TODO: In this scheme, indexes are computed for each bin of the</span>
<a name="line-259"></a>        <span class='hs-comment'>-- original histogram. It's sub-optimal as some parts of those indexes</span>
<a name="line-260"></a>        <span class='hs-comment'>-- (lower dimensions) don't change at each bin.</span>
<a name="line-261"></a>        <span class='hs-varid'>reIndex</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toLinearIndex</span> <span class='hs-varid'>sh'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toBin</span> <span class='hs-varid'>sh'</span> <span class='hs-varid'>sh</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromLinearIndex</span> <span class='hs-varid'>sh</span>
<a name="line-262"></a>        <span class='hs-varid'>ixs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>reIndex</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>enumFromN</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>shapeLength</span> <span class='hs-varid'>sh</span><span class='hs-layout'>)</span>
<a name="line-263"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh'</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>accumulate_</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>ixs</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-264"></a>
<a name="line-265"></a><span class='hs-comment'>-- Normalisation ---------------------------------------------------------------</span>
<a name="line-266"></a>
<a name="line-267"></a><a name="cumulative"></a><span class='hs-comment'>-- | Computes the cumulative histogram of another single dimension histogram.</span>
<a name="line-268"></a><span class='hs-comment'>--</span>
<a name="line-269"></a><span class='hs-comment'>-- @C(i) = SUM H(j)@ for each @j@ in @[0..i]@ where @C@ is the cumulative</span>
<a name="line-270"></a><span class='hs-comment'>-- histogram, and @H@ the original histogram.</span>
<a name="line-271"></a><span class='hs-definition'>cumulative</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-varid'>a</span>
<a name="line-272"></a><span class='hs-definition'>cumulative</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>scanl1'</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-273"></a><span class='hs-comment'>{-# SPECIALIZE cumulative :: Histogram DIM1 Int32  -&gt; Histogram DIM1 Int32
<a name="line-274"></a>                          ,  Histogram DIM1 Double -&gt; Histogram DIM1 Double
<a name="line-275"></a>                          ,  Histogram DIM1 Float  -&gt; Histogram DIM1 Float #-}</span>
<a name="line-276"></a><span class='hs-comment'>{-# INLINABLE cumulative #-}</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="normalize"></a><span class='hs-comment'>-- | Normalizes the histogram so that the sum of the histogram bins is equal to</span>
<a name="line-279"></a><span class='hs-comment'>-- the given value (normalisation by the @L1@ norm).</span>
<a name="line-280"></a><span class='hs-comment'>--</span>
<a name="line-281"></a><span class='hs-comment'>-- This is useful to compare two histograms which have been computed from images</span>
<a name="line-282"></a><span class='hs-comment'>-- with a different number of pixels.</span>
<a name="line-283"></a><span class='hs-definition'>normalize</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Real</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-284"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>b</span>
<a name="line-285"></a><span class='hs-definition'>normalize</span> <span class='hs-varid'>norm</span> <span class='hs-varop'>!</span><span class='hs-varid'>hist</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-286"></a>    <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>ratio</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>norm</span> <span class='hs-varop'>/</span> <span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-287"></a>        <span class='hs-varid'>equalizeVal</span> <span class='hs-varop'>!</span><span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realToFrac</span> <span class='hs-varid'>val</span> <span class='hs-varop'>*</span> <span class='hs-varid'>ratio</span>
<a name="line-288"></a>        <span class='hs-comment'>{-# INLINE equalizeVal #-}</span>
<a name="line-289"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>map</span> <span class='hs-varid'>equalizeVal</span> <span class='hs-varid'>hist</span>
<a name="line-290"></a><span class='hs-comment'>{-# SPECIALIZE normalize :: Double -&gt; Histogram sh Int32  -&gt; Histogram sh Double
<a name="line-291"></a>                         ,  Float  -&gt; Histogram sh Int32  -&gt; Histogram sh Float
<a name="line-292"></a>                         ,  Double -&gt; Histogram sh Double -&gt; Histogram sh Double
<a name="line-293"></a>                         ,  Float  -&gt; Histogram sh Double -&gt; Histogram sh Float
<a name="line-294"></a>                         ,  Double -&gt; Histogram sh Float  -&gt; Histogram sh Double
<a name="line-295"></a>                         ,  Float  -&gt; Histogram sh Float  -&gt; Histogram sh Float
<a name="line-296"></a>                         #-}</span>
<a name="line-297"></a><span class='hs-comment'>{-# INLINABLE normalize #-}</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="equalizeImage"></a><span class='hs-comment'>-- | Equalizes a single channel image by equalising its histogram.</span>
<a name="line-300"></a><span class='hs-comment'>--</span>
<a name="line-301"></a><span class='hs-comment'>-- The algorithm equalizes the brightness and increases the contrast of the</span>
<a name="line-302"></a><span class='hs-comment'>-- image by mapping each pixel values to the value at the index of the</span>
<a name="line-303"></a><span class='hs-comment'>-- cumulative @L1@-normalized histogram :</span>
<a name="line-304"></a><span class='hs-comment'>--</span>
<a name="line-305"></a><span class='hs-comment'>-- @N(x, y) = H(I(x, y))@ where @N@ is the equalized image, @I@ is the image and</span>
<a name="line-306"></a><span class='hs-comment'>-- @H@ the cumulative of the histogram normalized over an @L1@ norm.</span>
<a name="line-307"></a><span class='hs-comment'>--</span>
<a name="line-308"></a><span class='hs-comment'>-- See &lt;https://en.wikipedia.org/wiki/Histogram_equalization&gt;.</span>
<a name="line-309"></a><span class='hs-definition'>equalizeImage</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FunctorImage</span> <span class='hs-varid'>i</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Integral</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-310"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>ToHistogram</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-311"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>PixelValueSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImagePixel</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>DIM1</span><span class='hs-layout'>)</span>
<a name="line-312"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span>
<a name="line-313"></a><span class='hs-definition'>equalizeImage</span> <span class='hs-varid'>img</span> <span class='hs-keyglyph'>=</span>
<a name="line-314"></a>    <span class='hs-conid'>I</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>equalizePixel</span> <span class='hs-varid'>img</span>
<a name="line-315"></a>  <span class='hs-keyword'>where</span>
<a name="line-316"></a>    <span class='hs-varid'>hist</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>histogram</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>img</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-conid'>Int32</span>
<a name="line-317"></a>    <span class='hs-conid'>Z</span> <span class='hs-conop'>:.</span> <span class='hs-varid'>nBins</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shape</span> <span class='hs-varid'>hist</span>
<a name="line-318"></a>    <span class='hs-varid'>cumNormalized</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cumulative</span> <span class='hs-varop'>$</span> <span class='hs-varid'>normalize</span> <span class='hs-layout'>(</span><span class='hs-varid'>double</span> <span class='hs-varid'>nBins</span><span class='hs-layout'>)</span> <span class='hs-varid'>hist</span>
<a name="line-319"></a>    <span class='hs-varop'>!</span><span class='hs-varid'>cumNormalized'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>round</span> <span class='hs-varid'>cumNormalized</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-conid'>Int32</span>
<a name="line-320"></a>    <span class='hs-varid'>equalizePixel</span> <span class='hs-varop'>!</span><span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cumNormalized'</span> <span class='hs-varop'>!</span> <span class='hs-varid'>ix1</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span>
<a name="line-321"></a>    <span class='hs-comment'>{-# INLINE equalizePixel #-}</span>
<a name="line-322"></a><span class='hs-comment'>{-# INLINABLE equalizeImage #-}</span>
<a name="line-323"></a>
<a name="line-324"></a><span class='hs-comment'>-- Comparisons -----------------------------------------------------------------</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="compareCorrel"></a><span class='hs-comment'>-- | Computes the /Pearson\'s correlation coefficient/ between each</span>
<a name="line-327"></a><span class='hs-comment'>-- corresponding bins of the two histograms.</span>
<a name="line-328"></a><span class='hs-comment'>--</span>
<a name="line-329"></a><span class='hs-comment'>-- A value of 1 implies a perfect correlation, a value of -1 a perfect</span>
<a name="line-330"></a><span class='hs-comment'>-- opposition and a value of 0 no correlation at all.</span>
<a name="line-331"></a><span class='hs-comment'>--</span>
<a name="line-332"></a><span class='hs-comment'>-- @'compareCorrel' = SUM  [ (H1(i) - µ(H1)) (H1(2) - µ(H2)) ]</span>
<a name="line-333"></a><span class='hs-comment'>--                  / (   SQRT [ SUM [ (H1(i) - µ(H1))^2 ] ]</span>
<a name="line-334"></a><span class='hs-comment'>--                      * SQRT [ SUM [ (H2(i) - µ(H2))^2 ] ] )@</span>
<a name="line-335"></a><span class='hs-comment'>--</span>
<a name="line-336"></a><span class='hs-comment'>-- Where @µ(H)@ is the average value of the histogram @H@.</span>
<a name="line-337"></a><span class='hs-comment'>--</span>
<a name="line-338"></a><span class='hs-comment'>-- See &lt;<a href="http://en.wikipedia.org/wiki/Pearson_correlation_coefficient">http://en.wikipedia.org/wiki/Pearson_correlation_coefficient</a>&gt;.</span>
<a name="line-339"></a><span class='hs-definition'>compareCorrel</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Real</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-340"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-341"></a><span class='hs-definition'>compareCorrel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh1</span> <span class='hs-varid'>vec1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh2</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>)</span>
<a name="line-342"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sh1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>sh2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Histograms are not of equal size."</span>
<a name="line-343"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>denominat</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-344"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>numerat</span> <span class='hs-varop'>/</span> <span class='hs-varid'>denominat</span>
<a name="line-345"></a>  <span class='hs-keyword'>where</span>
<a name="line-346"></a>    <span class='hs-varid'>numerat</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-varid'>diff1</span> <span class='hs-varid'>diff2</span>
<a name="line-347"></a>    <span class='hs-varid'>denominat</span> <span class='hs-keyglyph'>=</span>   <span class='hs-varid'>sqrt</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>square</span> <span class='hs-varid'>diff1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-348"></a>                <span class='hs-varop'>*</span> <span class='hs-varid'>sqrt</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>square</span> <span class='hs-varid'>diff2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-349"></a>
<a name="line-350"></a>    <span class='hs-varid'>diff1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>v1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>realToFrac</span> <span class='hs-varid'>v1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>avg1</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec1</span>
<a name="line-351"></a>    <span class='hs-varid'>diff2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>v2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>realToFrac</span> <span class='hs-varid'>v2</span> <span class='hs-comment'>-</span> <span class='hs-varid'>avg2</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec2</span>
<a name="line-352"></a>
<a name="line-353"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>avg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>avg2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>avg</span> <span class='hs-varid'>vec1</span><span class='hs-layout'>,</span> <span class='hs-varid'>avg</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>)</span>
<a name="line-354"></a>    <span class='hs-varid'>avg</span> <span class='hs-varop'>!</span><span class='hs-varid'>vec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>vec</span><span class='hs-layout'>)</span>
<a name="line-355"></a><span class='hs-comment'>{-# SPECIALIZE compareCorrel
<a name="line-356"></a>    :: Shape sh =&gt; Histogram sh Int32  -&gt; Histogram sh Int32  -&gt; Double
<a name="line-357"></a>    ,  Shape sh =&gt; Histogram sh Int32  -&gt; Histogram sh Int32  -&gt; Float
<a name="line-358"></a>    ,  Shape sh =&gt; Histogram sh Double -&gt; Histogram sh Double -&gt; Double
<a name="line-359"></a>    ,  Shape sh =&gt; Histogram sh Double -&gt; Histogram sh Double -&gt; Float
<a name="line-360"></a>    ,  Shape sh =&gt; Histogram sh Float  -&gt; Histogram sh Float  -&gt; Double
<a name="line-361"></a>    ,  Shape sh =&gt; Histogram sh Float  -&gt; Histogram sh Float  -&gt; Float  #-}</span>
<a name="line-362"></a><span class='hs-comment'>{-# INLINABLE compareCorrel #-}</span>
<a name="line-363"></a>
<a name="line-364"></a><a name="compareChi"></a><span class='hs-comment'>-- | Computes the Chi-squared distance between two histograms.</span>
<a name="line-365"></a><span class='hs-comment'>--</span>
<a name="line-366"></a><span class='hs-comment'>-- A value of 0 indicates a perfect match.</span>
<a name="line-367"></a><span class='hs-comment'>--</span>
<a name="line-368"></a><span class='hs-comment'>-- @'compareChi' = SUM (d(i))@ for each indice @i@ of the histograms where</span>
<a name="line-369"></a><span class='hs-comment'>-- @d(i) = 2 * ((H1(i) - H2(i))^2 / (H1(i) + H2(i)))@.</span>
<a name="line-370"></a><span class='hs-definition'>compareChi</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Real</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-371"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-372"></a><span class='hs-definition'>compareChi</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh1</span> <span class='hs-varid'>vec1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh2</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>)</span>
<a name="line-373"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sh1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>sh2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Histograms are not of equal size."</span>
<a name="line-374"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>step</span> <span class='hs-varid'>vec1</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-num'>2</span>
<a name="line-375"></a>  <span class='hs-keyword'>where</span>
<a name="line-376"></a>    <span class='hs-varid'>step</span> <span class='hs-varop'>!</span><span class='hs-varid'>v1</span> <span class='hs-varop'>!</span><span class='hs-varid'>v2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>denom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>v2</span>
<a name="line-377"></a>                   <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>denom</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-378"></a>                        <span class='hs-keyword'>then</span> <span class='hs-num'>0</span>
<a name="line-379"></a>                        <span class='hs-keyword'>else</span> <span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-varid'>square</span> <span class='hs-layout'>(</span><span class='hs-varid'>v1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>realToFrac</span> <span class='hs-varid'>denom</span>
<a name="line-380"></a>    <span class='hs-comment'>{-# INLINE step #-}</span>
<a name="line-381"></a><span class='hs-comment'>{-# SPECIALIZE compareChi
<a name="line-382"></a>    :: Shape sh =&gt; Histogram sh Int32  -&gt; Histogram sh Int32  -&gt; Double
<a name="line-383"></a>    ,  Shape sh =&gt; Histogram sh Int32  -&gt; Histogram sh Int32  -&gt; Float
<a name="line-384"></a>    ,  Shape sh =&gt; Histogram sh Double -&gt; Histogram sh Double -&gt; Double
<a name="line-385"></a>    ,  Shape sh =&gt; Histogram sh Double -&gt; Histogram sh Double -&gt; Float
<a name="line-386"></a>    ,  Shape sh =&gt; Histogram sh Float  -&gt; Histogram sh Float  -&gt; Double
<a name="line-387"></a>    ,  Shape sh =&gt; Histogram sh Float  -&gt; Histogram sh Float  -&gt; Float  #-}</span>
<a name="line-388"></a><span class='hs-comment'>{-# INLINABLE compareChi #-}</span>
<a name="line-389"></a>
<a name="line-390"></a><a name="compareIntersect"></a><span class='hs-comment'>-- | Computes the intersection of the two histograms.</span>
<a name="line-391"></a><span class='hs-comment'>--</span>
<a name="line-392"></a><span class='hs-comment'>-- The higher the score is, the best the match is.</span>
<a name="line-393"></a><span class='hs-comment'>--</span>
<a name="line-394"></a><span class='hs-comment'>-- @'compareIntersect' = SUM (min(H1(i), H2(i))@ for each indice @i@ of the</span>
<a name="line-395"></a><span class='hs-comment'>-- histograms.</span>
<a name="line-396"></a><span class='hs-definition'>compareIntersect</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shape</span> <span class='hs-varid'>sh</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-397"></a>                 <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-398"></a><span class='hs-definition'>compareIntersect</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh1</span> <span class='hs-varid'>vec1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh2</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>)</span>
<a name="line-399"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sh1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>sh2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Histograms are not of equal size."</span>
<a name="line-400"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>min</span> <span class='hs-varid'>vec1</span> <span class='hs-varid'>vec2</span>
<a name="line-401"></a><span class='hs-comment'>{-# SPECIALIZE compareIntersect
<a name="line-402"></a>    :: Shape sh =&gt; Histogram sh Int32  -&gt; Histogram sh Int32  -&gt; Int32
<a name="line-403"></a>    ,  Shape sh =&gt; Histogram sh Double -&gt; Histogram sh Double -&gt; Double
<a name="line-404"></a>    ,  Shape sh =&gt; Histogram sh Float  -&gt; Histogram sh Float  -&gt; Float #-}</span>
<a name="line-405"></a><span class='hs-comment'>{-# INLINABLE compareIntersect #-}</span>
<a name="line-406"></a>
<a name="line-407"></a><a name="compareEMD"></a><span class='hs-comment'>-- | Computed the /Earth mover's distance/ between two histograms.</span>
<a name="line-408"></a><span class='hs-comment'>--</span>
<a name="line-409"></a><span class='hs-comment'>-- Current algorithm only supports histograms of one dimension.</span>
<a name="line-410"></a><span class='hs-comment'>--</span>
<a name="line-411"></a><span class='hs-comment'>-- See &lt;https://en.wikipedia.org/wiki/Earth_mover's_distance&gt;.</span>
<a name="line-412"></a><span class='hs-definition'>compareEMD</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Storable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-413"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Histogram</span> <span class='hs-conid'>DIM1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-414"></a><span class='hs-definition'>compareEMD</span> <span class='hs-varid'>hist1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>hist2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Histogram</span> <span class='hs-varid'>sh2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-415"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sh1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>sh2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Histograms are not of equal size."</span>
<a name="line-416"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Histogram</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vec1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cumulative</span> <span class='hs-varid'>hist1</span>
<a name="line-417"></a>                       <span class='hs-conid'>Histogram</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vec2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cumulative</span> <span class='hs-varid'>hist2</span>
<a name="line-418"></a>                   <span class='hs-keyword'>in</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>abs</span> <span class='hs-layout'>(</span><span class='hs-varid'>v1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>vec1</span> <span class='hs-varid'>vec2</span>
<a name="line-419"></a><span class='hs-comment'>{-# SPECIALIZE compareEMD
<a name="line-420"></a>    :: Histogram DIM1 Int32  -&gt; Histogram DIM1 Int32  -&gt; Int32
<a name="line-421"></a>    ,  Histogram DIM1 Double -&gt; Histogram DIM1 Double -&gt; Double
<a name="line-422"></a>    ,  Histogram DIM1 Float  -&gt; Histogram DIM1 Float  -&gt; Float #-}</span>
<a name="line-423"></a><span class='hs-comment'>{-# INLINABLE compareEMD #-}</span>
<a name="line-424"></a>
<a name="line-425"></a><a name="square"></a><span class='hs-definition'>square</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-426"></a><span class='hs-definition'>square</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>*</span> <span class='hs-varid'>a</span>
<a name="line-427"></a>
<a name="line-428"></a><a name="double"></a><span class='hs-definition'>double</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integral</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span>
<a name="line-429"></a><span class='hs-definition'>double</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-430"></a>
<a name="line-431"></a><a name="int"></a><span class='hs-definition'>int</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integral</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-432"></a><span class='hs-definition'>int</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
</pre></body>
</html>
